(function(window) {

	var ipsum = 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Phasellus in massa non lacus euismod molestie. Morbi pretium, est sit amet porttitor rhoncus, justo leo dignissim diam, ut aliquam tortor orci vitae ipsum. Sed tincidunt quam eu nulla varius ac tempus massa accumsan. Sed id volutpat dolor. Aliquam et ipsum eget nisi feugiat pulvinar. Suspendisse blandit tellus non orci pharetra vel euismod sapien porttitor. Mauris bibendum lorem sed orci tempus consectetur. Fusce odio ligula, placerat imperdiet bibendum sed, placerat ut nibh. Nullam tristique ultricies consectetur.\n\
Aliquam accumsan tincidunt risus, et bibendum leo imperdiet at. Ut congue libero in lectus volutpat porttitor. Mauris id velit scelerisque felis ultrices elementum eu id dui. Etiam porta, ipsum ac feugiat mattis, enim purus consectetur purus, aliquet porttitor erat odio quis nibh. Ut viverra lacinia rhoncus. Phasellus interdum augue et lacus mattis sagittis. Fusce bibendum, neque consectetur rhoncus convallis, elit velit laoreet dui, vestibulum ullamcorper erat felis ac magna. Mauris ornare enim nec turpis scelerisque volutpat. Morbi vel ligula felis, eget mollis orci. In lacinia nulla eu purus interdum quis vestibulum eros fringilla.\n\
Nunc eget venenatis enim. In vitae lectus odio. Suspendisse rutrum feugiat tincidunt. Nulla eu mauris vitae nulla tempor fringilla. Vestibulum leo urna, pretium eget semper sed, gravida in nunc. Nulla vulputate accumsan dolor, id euismod dui iaculis ac. Vivamus ullamcorper velit id elit elementum pharetra. Donec quis diam aliquet magna posuere tincidunt et non est. Sed mi felis, feugiat eget consequat sed, consequat quis ipsum. Curabitur dapibus turpis ut enim sagittis auctor. Quisque mattis, velit a hendrerit consequat, dui arcu tempor eros, a porttitor ipsum mi in felis. Nulla congue congue congue. Donec condimentum consectetur congue.\n\
Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Donec in magna nisl, at pellentesque elit. Vivamus lacus purus, dignissim et facilisis eu, mollis et turpis. Nam id tortor mauris, quis tincidunt libero. Maecenas eget cursus augue. Quisque congue mauris ac lectus ullamcorper quis dapibus dolor condimentum. Donec tellus leo, bibendum sit amet pretium quis, interdum vulputate ligula. Duis ac purus sed dui cursus ullamcorper ac quis orci. Quisque non risus justo. Fusce ullamcorper feugiat purus, vel malesuada justo laoreet vel. Donec at ipsum vitae felis condimentum iaculis vel quis sem. Ut sagittis rutrum tincidunt. Aliquam eu mauris vel sapien suscipit congue fringilla at arcu. Fusce lacinia congue convallis. Aenean nec sodales leo.\n\
Morbi varius dui quis ipsum aliquam auctor. Duis ultricies leo in nisi ultricies et ultrices lorem aliquam. Suspendisse adipiscing nunc et sem suscipit congue. Nunc malesuada malesuada est nec congue. Maecenas nunc mauris, pretium eu ornare non, pharetra eget odio. Suspendisse vitae lectus non massa vehicula ornare eget quis lacus. Nulla quis mi purus, non elementum felis. In convallis diam at erat elementum eget ornare nisl mattis. Maecenas pellentesque ligula ut dui luctus euismod.\n\
Donec ut mi a augue semper sodales eu in metus. Praesent eu fermentum justo. Quisque ac nisi libero. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Etiam vel mi sapien, ut fermentum tortor. Mauris tincidunt auctor turpis a luctus. Nullam scelerisque mattis metus, ac eleifend orci rutrum pretium. In rhoncus, nisl ac cursus tempor, mauris est hendrerit urna, sit amet venenatis libero enim ut velit. Nunc iaculis blandit tellus, sed volutpat eros interdum id. Suspendisse malesuada aliquam dignissim. Donec neque arcu, faucibus sit amet fringilla vitae, bibendum id nisi. Duis venenatis iaculis faucibus.\n\
Quisque elementum lorem eget risus facilisis nec bibendum lorem semper. Mauris adipiscing rhoncus eros ac rhoncus. Fusce venenatis lectus ac ipsum venenatis condimentum sit amet id diam. Vivamus a urna vitae lacus porttitor aliquam nec et magna. Sed ligula tellus, fringilla ut laoreet et, faucibus quis turpis. Fusce sit amet turpis nisi, ac elementum massa. Cras semper euismod nisi quis auctor. Quisque eget purus enim, in egestas orci. Suspendisse mattis neque vitae sem aliquam non lacinia diam vehicula.\n\
Maecenas eget diam nisl, a interdum orci. Morbi volutpat mauris ac nibh faucibus a consectetur sapien ultrices. Ut consequat, ante vitae rutrum venenatis, nibh tortor condimentum tellus, vel volutpat est leo vel orci. Sed enim lacus, tristique in tincidunt a, malesuada et dui. Curabitur nec porttitor tellus. Quisque ac neque ligula. Suspendisse potenti. Donec eleifend feugiat dolor, nec luctus dolor cursus eu. Mauris quis leo sit amet nibh tempus viverra sit amet eget urna. Etiam rutrum dui vel augue faucibus vestibulum. Quisque tempor lorem ac lorem aliquam tristique. Fusce non metus non lorem dapibus viverra nec et nulla. Cras rhoncus felis sit amet diam laoreet congue. Etiam eleifend, purus ac consectetur pellentesque, velit erat pulvinar turpis, ut congue nunc tellus eu ante.\n\
Duis accumsan luctus massa, nec porttitor quam blandit molestie. Nam suscipit egestas tincidunt. Etiam sem mi, rutrum ut dignissim non, fringilla ut erat. Nullam vel ligula dolor, non varius metus. Maecenas tortor ligula, congue non feugiat non, fringilla vitae massa. Suspendisse enim velit, pharetra nec congue et, molestie non nibh. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Cras lobortis placerat porta. Donec cursus gravida magna malesuada varius. Aliquam tincidunt nulla hendrerit nisl tristique vel bibendum lacus ullamcorper. Ut tempor ipsum in est suscipit eget suscipit leo euismod. Morbi malesuada euismod risus vitae ultrices. Vivamus vitae gravida nunc.\n\
Nullam eget porttitor neque. Suspendisse at sem nisl. Pellentesque a odio et est pellentesque semper at non orci. In sagittis fringilla libero gravida malesuada. Maecenas lacus nunc, cursus sit amet feugiat sed, vehicula eu lectus. Ut scelerisque tellus hendrerit diam consectetur ac tincidunt quam rhoncus. Fusce id mi ipsum, quis bibendum eros. Suspendisse consectetur consequat fermentum. Praesent gravida sagittis quam, sagittis blandit nisl interdum quis. Praesent tempus ultricies velit, ac adipiscing ante laoreet non. Aliquam posuere, mauris quis tempus dignissim, odio libero auctor mauris, ut ultrices enim turpis a metus. Maecenas velit ante, luctus at pulvinar non, semper dignissim velit. Suspendisse potenti. Aliquam non felis velit. Nullam interdum mollis arcu in condimentum. In ante arcu, sollicitudin ac posuere vel, tristique et metus.\n\
Donec non velit ac dui fermentum consectetur. Maecenas pretium, dui in tempor malesuada, dui ante varius orci, non pulvinar est dui a mi. Quisque semper, mauris ac venenatis mattis, leo magna facilisis ante, et lobortis eros lorem at tortor. Aliquam porta blandit enim vel posuere. Phasellus enim turpis, feugiat iaculis viverra vel, tincidunt nec diam. Aenean at fringilla sapien. Quisque nibh enim, tincidunt eu luctus ut, sollicitudin a odio. Vivamus semper odio at felis placerat consequat. In eu congue mi. Sed eros lacus, sollicitudin ut sagittis vel, aliquet ac velit. Suspendisse at elementum justo. Nam at libero dolor, iaculis dignissim lorem. Aliquam erat volutpat. Phasellus condimentum leo quis sem imperdiet nec tempor leo ullamcorper.\n\
Maecenas at aliquam turpis. Nunc in libero mauris. Ut lacinia faucibus ipsum, sed placerat nibh faucibus a. Mauris dapibus magna eget mi vulputate interdum. Nunc diam nunc, sagittis vitae venenatis nec, eleifend id lectus. In nec elit at elit elementum laoreet. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla id mauris eu velit posuere venenatis eu nec lectus. Nunc eget dolor eu turpis egestas sagittis. Duis id sapien justo, id accumsan orci. Vivamus euismod, dui quis eleifend ornare, erat felis dapibus felis, sit amet molestie justo tellus nec mi. Curabitur tortor massa, convallis fermentum elementum at, fermentum elementum erat. Praesent risus leo, tempor nec ultricies eget, tempor in dui. Mauris consectetur gravida facilisis. Fusce leo lorem, bibendum id fringilla nec, consequat id tortor. Curabitur quam turpis, fringilla a rhoncus vel, hendrerit id dui.\n\
Curabitur et magna ut magna molestie malesuada. Vivamus et lectus mi, sed cursus libero. Donec id erat metus. Pellentesque fermentum ligula non urna suscipit id venenatis odio pharetra. Nullam eget odio et orci ultricies vulputate. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Nunc et quam in erat luctus feugiat id nec mauris.\n\
Ut sed massa bibendum leo malesuada consequat. Aenean elementum lorem non felis cursus rutrum. Nulla eu mi dui. Nam feugiat, ipsum vitae tincidunt elementum, nibh libero tincidunt odio, nec vulputate tellus mauris at ipsum. Phasellus hendrerit venenatis malesuada. Integer cursus eleifend neque eu tincidunt. Proin volutpat bibendum blandit. Aliquam sit amet purus dolor. Curabitur iaculis ipsum eget elit posuere a congue dolor mattis. Suspendisse accumsan dolor eget quam imperdiet id commodo arcu suscipit. Proin ultrices laoreet consequat.\n\
Phasellus nec purus nisl. Sed gravida imperdiet tortor, in auctor quam tristique et. Aenean elementum libero sed erat luctus gravida. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Quisque rhoncus lacus vel lorem imperdiet sed cursus dolor posuere. Nulla facilisi. Donec posuere venenatis imperdiet. Sed nec massa felis. Fusce scelerisque, felis vel scelerisque dictum, leo tellus porttitor nisl, ut eleifend est arcu a eros. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Vivamus eu egestas mi. Maecenas justo arcu, scelerisque quis consectetur sit amet, interdum non lorem.\n\
Integer tincidunt sapien sit amet ipsum adipiscing lobortis mattis enim laoreet. Mauris tincidunt diam ut odio interdum et volutpat mauris adipiscing. Mauris eget quam vel ante posuere eleifend quis ut tortor. Integer non lectus nisi. Quisque at turpis mi, quis sagittis mauris. Donec faucibus, metus eu interdum tincidunt, eros augue cursus neque, tincidunt pellentesque nibh velit vitae tortor. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Phasellus id quam mi, vel malesuada lectus. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Maecenas sollicitudin arcu eu erat vestibulum non imperdiet metus elementum. Vivamus eleifend luctus libero, nec gravida erat laoreet nec. Donec porttitor metus sit amet quam venenatis ornare. Mauris in ante quis nisi pulvinar tincidunt.\n\
Maecenas nibh mauris, mattis sit amet dignissim id, elementum ac libero. Nunc sit amet neque turpis, quis condimentum lorem. Vestibulum non ipsum libero, non interdum lectus. Etiam justo quam, varius non lobortis a, euismod interdum nibh. Donec nisi felis, molestie at commodo vitae, pharetra eget est. Aenean interdum leo non diam mattis posuere. Praesent quis condimentum ipsum. Donec ipsum nisi, suscipit ut vehicula in, lobortis ac nisl. In rutrum pharetra ante. Curabitur mi augue, vestibulum vitae vehicula a, ultrices non eros. Sed ornare quam ut est pretium blandit. Suspendisse congue sodales lectus, ut dapibus purus facilisis in. Suspendisse volutpat massa nec lacus lobortis tincidunt. Quisque semper, nisl ut vulputate porttitor, lorem ante cursus justo, id tempor velit mauris non metus. Quisque id metus mauris.\n\
Nunc ut lectus mauris, quis hendrerit nunc. Pellentesque ante quam, accumsan at posuere ac, suscipit non lacus. Suspendisse potenti. Sed vitae augue enim, vel cursus nibh. Fusce mauris orci, accumsan ut lacinia et, ornare sed dui. Nullam dapibus dui at diam ultrices dignissim pretium arcu rhoncus. Donec viverra convallis turpis vel ullamcorper. Maecenas non lorem eu est euismod commodo sed ut risus. Morbi eleifend ultricies egestas. Mauris id neque ipsum, at facilisis elit.\n\
Aliquam in odio orci, quis tempus urna. Nulla ac lectus a turpis bibendum sollicitudin. Praesent aliquam libero tempor nulla aliquet sit amet vulputate lectus aliquet. Proin iaculis diam laoreet purus consequat interdum. Nullam feugiat semper tortor, at facilisis mi blandit ut. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Fusce et mi vitae ligula tempor placerat eu nec augue. Praesent vel sem nisl. Aliquam ullamcorper metus ac libero viverra vestibulum. Curabitur et libero nisl, sed faucibus nisi. Duis arcu est, fermentum non euismod ut, lacinia ut lorem. Nulla feugiat tellus egestas sapien sodales eleifend. Curabitur elit lacus, condimentum in consectetur ut, rutrum et eros. Proin suscipit lectus at arcu laoreet id viverra orci cursus.\n\
Nam porta, elit non tincidunt placerat, enim arcu mollis enim, eu tincidunt neque purus a nisi. Cras hendrerit egestas dui, a aliquam sem posuere sed. Aenean vulputate consectetur mauris, non iaculis mauris commodo vel. Duis ultricies lacinia arcu, ac luctus lacus viverra luctus. Cras sagittis varius sodales. Donec auctor, lectus vitae rhoncus mattis, orci sem aliquam libero, in tempor elit lectus in velit. Pellentesque eu risus diam. Quisque placerat lacus ut ante cursus id pharetra nunc blandit. Vivamus scelerisque gravida metus, nec dictum ipsum feugiat id. Nullam aliquet placerat dignissim. Aenean congue, lacus a convallis tempus, enim lacus lobortis risus, vel ultricies ipsum augue sed eros. Sed nisl nisl, cursus vitae posuere sit amet, congue vehicula velit. Sed pellentesque nunc vitae augue venenatis ut tincidunt nibh posuere. Nunc interdum, sapien ac laoreet ullamcorper, nunc enim ornare sem, a fermentum augue erat et magna.';

	window.ipsum = ipsum;
})(window);/**
 * Ipsum Fly v.0.1.0
 * Structured Lorem Ipsum on the fly
 * A jQuery plugin to quickly prototype page content using Lorem Ipsum sample text.
 *
 * Copyright 2013 David Street
 * Licensed under the MIT license.
 */

(function($, ipsum) {

	/**
	 * Utility method to pull a specific property out of an array
	 * of objects.
	 *
	 * @function pluck
	 * @param arr The array to search
	 * @param prop The property to pull
	 * @returns {Array}
	 */
	function pluck(arr, prop) {
		var returnArr = [];

		for (var i = 0; i < arr.length; i += 1) {
			if (arr[i].hasOwnProperty(prop)) {
				returnArr.push(arr[i][prop]);
			}
		}

		return returnArr;
	}

	/**
	 * Lorem Ipsum generator class
	 * 
	 * @class IpsumGenerator
	 */
	var IpsumGenerator = function() {
		this.ipsum = ipsum;

		/*
		 * TODO: Consider adding two different child attachment options: insert and integrate. Currently only supporting insertion.
		 */
		this.options = {
			attrPrefix: 'data-ifly-',
			defaultRules: {
				type: 'word',
				position: 'before',
				maxSize: 2,
				repeat: 0,
				attachment: 'insert'
			},
			// Groups array must be in order of precedence, with the highest precedence at the end.
			groups: [
				{
					tags: [
						'a', 'abbr', 'acroynm', 'b', 'big', 'cite', 'code', 'details', 'em',
						'i', 'label', 'q', 'samp', 'small', 'source', 'span', 'strong', 'sub',
						'summary', 'sup', 'texarea', 'tt'
					],
					rules: {
						position: 'random',
						maxSize: 4
					}
				},
				{
					tags: [
						'address', 'article', 'blockquote', 'div', 'dl', 'figcaption', 'h1', 'h2', 'h3',
						'h4', 'h5', 'h6', 'header', 'ol', 'p', 'pre', 'table', 'section', 'ul', 'li',
						'dd', 'dt', 'td'
					],
					rules: {
						type: 'paragraph',
						position: 'after',
						maxSize: 2,
					}
				},
				{
					tags: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6'],
					rules: {
						type: 'word',
						position: 'before',
						maxSize: 5
					}
				}
			],
			tags: {
				'ul': {
					type: 'none'
				},
				'div': {
					type: 'none'
				},
				'li': {
					type: 'word',
					maxSize: 6
				}
			}
		};
	};


	/**
	 * Utility method to return an extended options object. The method will append any
	 * array elements to an array, extend an object, and set the value for any primative
	 * data type.
	 * 
	 * @function extendOptions
	 * @param options The options to extend with
	 * @returns {Object}
	 */
	IpsumGenerator.prototype.extendOptions = function(options) {
		var newOptions = $.extend({}, this.options);

		for (var prop in options) {
			if (newOptions.hasOwnProperty(prop)) {
				// If the property is an array, append it to the end of the original.
				if ($.isArray(options[prop])) {
					newOptions[prop] = newOptions[prop].concat(options[prop]);
				// If the property is an object, extend the original.
				} else if (typeof(options[prop]) === 'object') {
					$.extend(newOptions[prop], options[prop]);
				// Anything else, set the value.
				} else {
					newOptions[prop] = options[prop];
				}
			}
		}

		this.options = newOptions;
	};

	
	/**
	 * Utility method to return a slice from an array. Looping back on itself it exceeds
	 * it's range.
	 * 
	 * @function loopSlice
	 * @param arr The array to slice
	 * @param start The starting index
	 * @param len The number of elements to return
	 * @param reverse Whether to reverse the direction
	 * @returns {Array}
	 */
	IpsumGenerator.prototype.loopSlice = function(arr, start, len, reverse) {
		var arrLen = arr.length
			, returnArr = []
			, reverse = (reverse != undefined ? reverse : false)
			, i = start
			, pos = (!reverse ? start-1 : start+1);

		// If we do not need to loop, then fallback to the slice method.
		if (!reverse && (start + len) <= arrLen) {
			return arr.slice(start, start+len);
		}

		// Loop through the array until we have all the elements we need.
		for (i; i < (start + len); i += 1) {
			if (!reverse) {
				if (pos >= (arrLen-1)) {
					pos = 0;
				} else {
					pos += 1;
				}
			} else {
				if (pos <= 0) {
					pos = (arrLen - 1);
				} else {
					pos -= 1;
				}
			}
			returnArr.push(arr[pos]);
		}

		return returnArr;
	}


	/**
	 * Utility method to parse the placeholders in a string.
	 * 
	 * @function parsePlaceholders
	 * @param searchStr The string to search
	 * @param replaceArr The array with values to populate
	 * @returns {String}
	 */
	IpsumGenerator.prototype.parsePlaceholders = function(searchStr, replaceArr) {		
		var matches = searchStr.match(/{[0-9]+}/g)
			, index = undefined
			, returnStr = searchStr;

		for (m in matches) {
			index = parseInt(matches[m].match(/[0-9]+/)[0]);
			returnStr = searchStr.replace('{'+index+'}', this.parsePlaceholders(replaceArr[index], replaceArr));
		}

		return returnStr;
	};

	
	/**
	 * Method to return an array of text items
	 * 
	 * @function getTextItems
	 * @param num The number of paragraphs to return
	 * @param type The type of text item to return. Values include `paragraph`, `word`, or `character`.
	 * @param startWith Whether or not to start with `Loreum Ipsum`
	 * @returns {String}
	 */
	IpsumGenerator.prototype.getTextItems = function(num, type, startWith) {
		var allItems = []
			, startWith = (startWith != undefined ? startWith : true)
			, startIndex = 0;

		// Get the text items based on the type provided.
		switch (type) {
			case 'word':
				allItems = this.ipsum.split(' ');
				break;
			case 'character':
				allItems = this.ipsum.replace('\n', '').split('');
				break;
			case 'paragraph':
			default:
				allItems = this.ipsum.replace('\n', '').split('\n');
				break;
		}

		if (!startWith) {
			// Choose a random starting index.
			startIndex = Math.floor(Math.random() * allItems.length + 1);
		}
		
		return this.loopSlice(allItems, startIndex, num);
	}


	/**
	 * Method to get the options for the particular element. Precedence is given in the following order:
	 * HTML data attributes, explicit tag options, block or inline tag options, default tag options
	 * 
	 * @function getElementOptions
	 * @param $ele The jQuery element
	 * @returns {Object}
	 */
	IpsumGenerator.prototype.getElementOptions = function($ele) {
		var optionKeys = ['repeat', 'position', 'maxSize', 'type', 'attachment']
			, tagname = $ele[0].tagName.toLowerCase()
			, returnOptions = $.extend({}, this.options.defaultRules)
			, attrValue = ''
			, i = 0;

		// Get options from group defaults
		for (var g = 0; g < this.options.groups.length; g += 1) {
			if (this.options.groups[g].tags.indexOf(tagname) != -1 && this.options.groups[g].hasOwnProperty('rules')) {
				$.extend(returnOptions, this.options.groups[g].rules);
			}
		}

		// Get explicit options for the specific tagname
		if (this.options.tags.hasOwnProperty(tagname)) {
			$.extend(returnOptions, this.options.tags[tagname]);
		}

		// Get options set in the data attributes
		for (i; i < optionKeys.length; i += 1) {
			attrValue = $ele.attr(this.options.attrPrefix + optionKeys[i]);

			if (attrValue) {
				returnOptions[optionKeys[i]] = $ele.attr(this.options.attrPrefix + optionKeys[i]);
			}

		}

		return returnOptions;
	};


	/**
	 * Method to return the HTML for an element including all of it's children
	 * 
	 * @function getHtml
	 * @param $ele The jQuery element
	 * @param $parent The jQuery parent element
	 * @returns {Object}
	 */
	IpsumGenerator.prototype.getHtml = function($ele, $parent) {
		var $children = $ele.children()
			, elementOptions = this.getElementOptions($ele)
			, children = []
			, pos = 0
			, elePos = 0
			, size = Math.floor(Math.random() * elementOptions.maxSize + 1)
			, delimiter = ' '
			, $tmpEle = null
			, tmpHtml = ''
			, parentTextItems = undefined
			, newTextItems = []
			, self = this;

		switch (elementOptions.type) {
			case 'paragraph':
				delimiter = '\n';
				if (elementOptions.attachment != 'integrate') {
					newTextItems = this.getTextItems(size, 'paragraph', false);
				}
				break;
			case 'character':
				delimiter = '';
				if (elementOptions.attachment != 'integrate') {
					newTextItems = this.getTextItems(size, 'character', false);
				}
				break;
			case 'none':
				// Keep the inner html structure intact with child elements in their current positions
				children = $ele.contents();
				for (var c = 0; c < children.length; c += 1) {
					if (children[c].nodeType == 3) { // Text node
						tmpHtml += children[c].nodeValue;
					} else {
						tmpHtml += this.getHtml($(children[c]), $ele).html;
					}
				}
				newTextItems = [tmpHtml];
				children = [];
				break;
			default:
			case 'word':
				delimiter = ' ';
				if (elementOptions.attachment != 'integrate') {
					newTextItems = this.getTextItems(size, 'word', false);
				}
				break;
		}

		// If we are working with a child element that needs to be inserted into the parent
		if ($parent != undefined) {
			parentTextItems = $parent.text().split(delimiter);

			switch (elementOptions.position) {
				case 'random':
					pos = Math.floor(Math.random() * parentTextItems.length);
					
					// Get the text items from the parent when integrating
					if (elementOptions.attachment === 'integrate' && elementOptions.type != 'none') {
						// Ensure size does not exeed the number of text items
						if (size > parentTextItems.length) {
							size = parentTextItems.length;
						}

						// Ensure we don't exceed the number of text items
						if (pos + size > parentTextItems.length) {
							pos = (parentTextItems.length) - size;
						}

						// Get new text items
						newTextItems = parentTextItems.slice(pos, pos+size);

						// Remove text items from parent
						parentTextItems.splice(pos, size);
					}
					break;
				case 'after':
					pos = parentTextItems.length;
					break;
				default:
				case 'before':
					pos = 0;
					break;
			}

			elePos = parentTextItems.slice(0, pos).join(delimiter).length;
		}

		$tmpEle = $ele.clone().empty().html(newTextItems.join(delimiter));

		// Get the HTML for each child element
		if (elementOptions.type !== 'none') {
			$children.each(function(c){
				newChild = self.getHtml($(this), $tmpEle);
				children.push(newChild);

				// If the child altered the parent text, then apply the changes
				// Used when integrating child elements into the parent
				if (newChild.parentText != undefined) {
					$tmpEle.text(newChild.parentText);
				}
				
				// Insert a placeholder for the child into the html of the parent element
				$tmpEle = $ele.clone().empty().text(
					$tmpEle.text().substring(0, newChild.position) + ' {' + c + '} ' + $tmpEle.text().substring(newChild.position)
				);

			});
		}

		tmpHtml = $tmpEle[0].outerHTML;

		// Replace placeholers with the proper child html
		for (c in children) {

			// Find placeholders within child
			// Used when integrating child elements into the parent
			children[c].html = this.parsePlaceholders(children[c].html, pluck(children, 'html'));

			tmpHtml = tmpHtml.replace('{'+c+'}', children[c].html);

		}

		// Repeat element if needed
		if (elementOptions.hasOwnProperty('repeat')) {
			$tmpEle = $ele.clone().removeAttr(this.options.attrPrefix + 'repeat');

			for (var i = 0; i < elementOptions.repeat; i += 1) {
				tmpHtml += this.getHtml($tmpEle, $parent).html;
			}
		}

		// Remove any white space between two html tags
		tmpHtml = tmpHtml.replace(/>\s+</g, '><');

		return {
			html: tmpHtml,
			position: elePos,
			parentText: (parentTextItems != undefined) ? parentTextItems.join(delimiter) : undefined
		};

	}

	// For testing purposes only
	window.IpsumGenerator = IpsumGenerator;
	
	$.fn.ipsumFly = function() {
		return this.each(function() {
			var ipsumGenerator = new IpsumGenerator();

			newHtml = ipsumGenerator.getHtml($(this)).html;
			this.outerHTML = newHtml;
		});
	};

})(jQuery, ipsum)